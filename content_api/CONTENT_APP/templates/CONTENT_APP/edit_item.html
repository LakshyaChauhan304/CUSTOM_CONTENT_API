{% extends "CONTENT_APP/base.html" %}
{% load static %}

{% block title %}Edit Item{% endblock %}

{% block content %}
<div class="flex justify-center fade-in">
    <div class="glass-card" style="width: 100%; max-width: 800px;">
        <h2 style="margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">Edit Content</h2>

        <form id="editItemForm" onsubmit="handleEditItem(event)">
            {% csrf_token %}

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Title</label>
                <input type="text" id="title" name="title" placeholder="Enter a descriptive title..." required
                    class="form-control" style="font-size: 1.1rem; padding: 1rem;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status</label>
                <select id="status" name="status" class="form-control"
                    style="font-size: 1rem; padding: 0.75rem; width: 100%; border-radius: 0.5rem;">
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Content Body</label>
                <!-- Quill Editor Container -->
                <div id="editor-container" style="height: 300px; background: white;"></div>
                <input type="hidden" id="body" name="body">
            </div>

            <div class="flex justify-end gap-4">
                <a href="{% url 'items_list' %}" class="btn btn-outline">Cancel</a>
                <button class="btn btn-primary" type="submit" style="min-width: 150px;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Include Quill Stylesheet -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Include Quill Library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
    // Initialize Quill editor
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'Write your content here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });

    const itemId = window.location.pathname.split('/').filter(Boolean).pop();

    async function loadItemData() {
        try {
            const response = await fetch(`/content/api/items/${itemId}/`);
            if (!response.ok) throw new Error('Failed to fetch item');
            const data = await response.json();

            document.getElementById('title').value = data.title;
            document.getElementById('status').value = data.status || 'in_progress';
            // Set Quill content
            quill.clipboard.dangerouslyPasteHTML(data.body);
        } catch (error) {
            console.error('Error loading item:', error);
            alert('Failed to load item data.');
        }
    }

    loadItemData();

    async function handleEditItem(event) {
        event.preventDefault();

        const title = document.getElementById('title').value;
        const status = document.getElementById('status').value;
        // Get HTML content from Quill
        const body = document.querySelector('.ql-editor').innerHTML;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerText = "Saving...";

        try {
            const response = await fetch(`/content/api/items/${itemId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    title: title,
                    body: body,
                    status: status
                })
            });

            if (response.ok) {
                window.location.href = "{% url 'items_list' %}";
            } else {
                const data = await response.json();
                alert('Error updating item: ' + (data.detail || JSON.stringify(data)));
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An unexpected error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerText = originalText;
        }
    }
</script>
{% endblock %}